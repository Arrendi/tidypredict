---
title: "Random Forest model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{randomForest}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
menu:
  main:
    parent: "articles"
    weight: 1
---

```{r setup, include=FALSE}
library(dplyr)
library(tidypredict)
library(randomForest)
set.seed(100)
```

## Highlights & Limitations

- Uses the `randomForest::getTree()` to parse each decision path.
- In-line functions in the fomulas are **not supported**:  
   - OK - `wt ~ mpg + am` 
   - OK - `mutate(mtcars, newam = paste0(am))` and then `wt ~ mpg + newam`
   - Not OK - `wt ~ mpg + as.factor(am)`
   - Not OK - `wt ~ mpg + as.character(am)`
- Interval functions are not supported: `tidypredict_interval()` & `tidypredict_sql_interval()`
   

## How it works

Here is a simple `randomForest()` model using the `iris` dataset:
```{r}
library(randomForest)
model <- randomForest(Species ~ .,data = iris ,ntree = 100, proximity = TRUE)
```

The SQL translations returns a single SQL `CASE WHEN` operation.  Each decision path is a `WHEN` statement.
```{r}
library(tidypredict)

tidypredict_sql(model, dbplyr::simulate_mssql())
```

Alternatively, use `tidypredict_to_column()` if the results are the be used or previewed in `dplyr`.

```{r}
iris %>%
  tidypredict_to_column(model) %>%
  head(10)
```

## Under the hood

The parser is based on the ouput from the `randomForest::getTree()` function.  It will return as many desicion paths as there are non-NA rows in the `prediction` field.
```{r}
getTree(model, labelVar = TRUE) %>%
  head()
```

The parsed model contains one row for each path.  The `field`, `operator` and `split_point` field list every step in a concatenated character variable.
```{r}
parse_model(model)
```

The Tidy Eval formula is one `dplyr::case_when()` statement
```{r}
tidypredict_fit(model)
```


## How it performs

Currently, the formula matches 147 out of 150 prediction for Iris
```{r}
test <- tidypredict_test(model, iris, threshold = 5)

test

test$raw_results %>%
  filter(predict != tidypredict)
```