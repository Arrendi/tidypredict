---
title: "lm model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{lm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(dplyr)
library(tidypredict)
```


## Example

```{r}
library(dplyr)
library(tidypredict)

df <- mtcars %>%
  mutate(cyl = paste0("cyl", cyl))

model <- lm(mpg ~ wt + am + cyl, data = df)

model
```

### `tidypredict_to_column()`

```{r}
df %>%
  head(10) %>%
  tidypredict_to_column(model)
```


Compare the results against `predict()`

```{r}
predict(model, head(df,10))
```

To include the prediction intervals just use the `add_interval` switch
```{r}
df %>%
  head(10) %>%
  tidypredict_to_column(model, add_interval = TRUE) %>%
  select(fit, lower, upper)
```


Compare the results against `predict()`

```{r}
predict(model, head(df,10), interval = "prediction")
```


### Prediction functions

To see the prediction formula, call the `tidypredict_fit()` function.  Because it uses S3 methods, it will decide which parser and formula generator to use for the model passed in the argument.

```{r}
tidypredict_fit(model)
```

If more granular control than what `tidypredict_to_column()` is needed, then the function can be used inside a `dplyr` verb command

```{r}
df %>%
  head(10) %>%
  mutate(fit = !! tidypredict_fit(model))
```



To add prediction intervals, an additional calculation is needed against the fitted result
```{r}
df %>%
  head(10) %>%
  mutate(fit = !! tidypredict_fit(model),
         lwr = fit + !! tidypredict_interval(model),
         upr = fit - !! tidypredict_interval(model)) %>%
  select(fit, lwr, upr)
```

The confidence interval can also be modified, the default is 0.95

```{r}
tidypredict_interval(model, interval = 0.99)
```

### Model parser

The `parse_model()` function returns a tidy table with the data needed to run the predictions

```{r}
parse_model(model)
```

`tidypredict_fit()` does not need all of the columns in this table, it only requires the first four. The `qr_...` fields are use to calculate the prediction intervals, the are the result of running `qr.solve()` against the model's `qr` variable.

### Save, and reload, a parsed model

The output of the model parser can be saved as a `.csv` file and reloaded at a later time.  The prediction functions have an S3 method for `data.frame`, so the `model` entry is used to determine which predict formula to compile.

```{r}
write.csv(parse_model(model), "model.csv")


reloaded_model <- read.csv("model.csv")

df %>%
  head(10) %>%
  tidypredict_to_column(reloaded_model, add_interval = TRUE, vars = c("ft", "up", "lw")) %>%
  select(ft, lw, up)
```
