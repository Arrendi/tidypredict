---
title: "lm model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{lm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(dplyr)
library(tidypredict)
```


## Example

```{r}
library(dplyr)
library(tidypredict)

df <- mtcars %>%
  mutate(cyl = paste0("cyl", cyl))

model <- lm(mpg ~ wt + am + cyl, data = df)

model
```

### `tidypredict_to_column()`

```{r}
df %>%
  head(10) %>%
  tidypredict_to_column(model)
```


Compare the results against `predict()`

```{r}
predict(model, head(df,10))
```

To include the prediction intervals just use the `add_interval` switch
```{r}
df %>%
  head(10) %>%
  tidypredict_to_column(model, add_interval = TRUE) %>%
  select(fit, lower, upper)
```


Compare the results against `predict()`

```{r}
predict(model, head(df,10), interval = "prediction")
```


### Prediction functions

To see the prediction formula, call the `tidypredict_fit()` function.  Because it uses S3 methods, it will decide which parser and formula generator to use for the model passed in the argument.

```{r}
tidypredict_fit(model)
```

If more granular control than what `tidypredict_to_column()` is needed, then the function can be used inside a `dplyr` verb command

```{r}
df %>%
  head(10) %>%
  mutate(fit = !! tidypredict_fit(model))
```



To add prediction intervals, an additional calculation is needed against the fitted result
```{r}
df %>%
  head(10) %>%
  mutate(fit = !! tidypredict_fit(model),
         lwr = fit + !! tidypredict_interval(model),
         upr = fit - !! tidypredict_interval(model)) %>%
  select(fit, lwr, upr)
```

The confidence interval can also be modified, the default is 0.95

```{r}
tidypredict_interval(model, interval = 0.99)
```

### Model parser

The `parse_model()` function returns a tidy table with the data needed to run the predictions

```{r}
parse_model(model)
```

`tidypredict_fit()` does not need all of the columns in this table, it only requires the first four. The `qr_...` fields are use to calculate the prediction intervals, the are the result of running `qr.solve()` against the model's `qr` variable.

### Save, and reload, a parsed model

The output of the model parser can be saved as a `.csv` file and reloaded at a later time.  The prediction functions have an S3 method for `data.frame`, so the `model` entry is used to determine which predict formula to compile.

```{r}
write.csv(parse_model(model), "model.csv")


reloaded_model <- read.csv("model.csv")

df %>%
  head(10) %>%
  tidypredict_to_column(reloaded_model, add_interval = TRUE, vars = c("ft", "up", "lw")) %>%
  select(ft, lw, up)
```

### Test results

For good measure, the `tidypredict_test()` function will run the `predict()` command and `tidypredict_to_column()` and then compares the results.  Because of decimal precision, some results will be different, but by a very, very small amount.  That's why the comparison tests that `tidypredict_test()` run focuses on a difference **threshold**.  The default threshold is: 0.000000000001.

It is highly recommended to run this test to confirm that the output of the `tidypredict` functions are within acceptable ranges.


`tidypredict_test()` has a custom `print` and `knit_print` methods that return a summary of the results:
```{r}
model <- lm(mpg ~ wt + am + cyl, data = df)

tidypredict_test(model, include_intervals = TRUE)
```

The `threshold` is reduced to 1e-16 to see the response of a "failing" test.

```{r}
tidypredict_test(model, include_intervals = TRUE, threshold = 0.0000000000000001)
```

`tidypredict_test()` returns a list that contains a `data.frame` with the raw results, the model call and the message.  Additionally, an output called `alert` is included in case the test is to be automated and there's a need to easily tell the R script running the test that there is a problem.

```{r}
results <- tidypredict_test(model, include_intervals = TRUE, threshold = 0.0000000000000001)

results
```

This is an sample of the raw results of the test:
```{r}
head(results$raw_results)
```

The `alert` output is set to TRUE because, because at least one of the `_threshold` fields are TRUE

```{r}
results$alert
```
